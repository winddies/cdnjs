import{__decorate,__param}from"tslib";import{Inject,Injectable}from"@angular/core";import{ReplaySubject}from"rxjs";import{filter}from"rxjs/operators";import{DefaultConfig}from"./angulartics2-config";import{ANGULARTICS2_TOKEN}from"./angulartics2-token";import{RouterlessTracking,TrackNavigationEnd}from"./routerless";import*as i0 from"@angular/core";import*as i1 from"./routerless";import*as i2 from"./angulartics2-token";let Angulartics2=class{constructor(e,t){this.tracker=e,this.pageTrack=new ReplaySubject(10),this.eventTrack=new ReplaySubject(10),this.exceptionTrack=new ReplaySubject(10),this.setAlias=new ReplaySubject(10),this.setUsername=new ReplaySubject(10),this.setUserProperties=new ReplaySubject(10),this.setUserPropertiesOnce=new ReplaySubject(10),this.setSuperProperties=new ReplaySubject(10),this.setSuperPropertiesOnce=new ReplaySubject(10),this.userTimings=new ReplaySubject(10);const r=new DefaultConfig;this.settings=Object.assign(Object.assign({},r),t.settings),this.settings.pageTracking=Object.assign(Object.assign({},r.pageTracking),t.settings.pageTracking),this.tracker.trackLocation(this.settings).subscribe(e=>this.trackUrlChange(e.url))}filterDeveloperMode(){return filter((e,t)=>!this.settings.developerMode)}trackUrlChange(e){if(this.settings.pageTracking.autoTrackVirtualPages&&!this.matchesExcludedRoute(e)){const t=this.clearUrl(e);let r;r=this.settings.pageTracking.basePath.length?this.settings.pageTracking.basePath+t:this.tracker.prepareExternalUrl(t),this.pageTrack.next({path:r})}}matchesExcludedRoute(e){for(const t of this.settings.pageTracking.excludedRoutes){if(t instanceof RegExp&&t.test(e)||-1!==e.indexOf(t))return!0}return!1}clearUrl(e){return this.settings.pageTracking.clearIds||this.settings.pageTracking.clearQueryParams||this.settings.pageTracking.clearHash?e.split("/").map(e=>this.settings.pageTracking.clearQueryParams?e.split("?")[0]:e).map(e=>this.settings.pageTracking.clearHash?e.split("#")[0]:e).filter(e=>!this.settings.pageTracking.clearIds||!e.match(this.settings.pageTracking.idsRegExp)).join("/"):e}};Angulartics2.ctorParameters=(()=>[{type:RouterlessTracking},{type:void 0,decorators:[{type:Inject,args:[ANGULARTICS2_TOKEN]}]}]),Angulartics2.ɵprov=i0.ɵɵdefineInjectable({factory:function(){return new Angulartics2(i0.ɵɵinject(i1.RouterlessTracking),i0.ɵɵinject(i2.ANGULARTICS2_TOKEN))},token:Angulartics2,providedIn:"root"}),Angulartics2=__decorate([Injectable({providedIn:"root"}),__param(1,Inject(ANGULARTICS2_TOKEN))],Angulartics2);export{Angulartics2};